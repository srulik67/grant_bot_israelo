<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</title>

  <!-- favicon ×§×˜×Ÿ ×›×“×™ ×œ×× ×•×¢ 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ¤%3C/text%3E%3C/svg%3E">

  <!-- Dialogflow Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,"Segoe UI",Arial,sans-serif;
      background:
        linear-gradient(rgba(255,255,255,.75), rgba(255,255,255,.75)),
        url('gem.png') center / cover fixed no-repeat;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px}
    p{margin:0 0 12px;color:#444}

    df-messenger{
      position:fixed; bottom:16px; right:16px; z-index:999; direction:rtl;
      --df-messenger-font-family:system-ui,"Segoe UI",Arial,sans-serif;
    }
    #micBtn{
      position:fixed; bottom:90px; right:16px; z-index:1000;
      padding:10px 14px; border:0; border-radius:999px;
      background:#0b57d0; color:#fff; cursor:pointer; font-size:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
      min-width:160px;
    }
    #micBtn[aria-busy="true"]{ background:#d00 }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</h1>
    <p>×“×•×’×××•×ª: â€œ××” ×–××Ÿ ×”×˜×™×¤×•×œ ×œ××¢× ×§?â€, â€œ××™ ×–×›××™ ×œ××¢× ×§?â€, â€œ××™×š ××’×™×©×™× ×‘×§×©×”?â€.</p>
  </div>

  <!-- ×›×¤×ª×•×¨ ××™×§×¨×•×¤×•×Ÿ -->
  <button id="micBtn" type="button" title="×“×‘×¨/×™">ğŸ¤ ×“×‘×¨/×™</button>

  <!-- ×”×•×•×™×“×’'×˜ -->
  <df-messenger
    project-id="sandbox-kosta-test"
    agent-id="bc0af719-bdac-48d8-ba78-3befdd3c5a00"
    location="europe-west1"
    language-code="he-il"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="×‘×•×˜ ××¢× ×§ ×¢×‘×•×“×”"></df-messenger-chat-bubble>
  </df-messenger>

  <script>
  (() => {
    const df      = document.querySelector('df-messenger');
    const bubble  = document.querySelector('df-messenger-chat-bubble');
    const mic     = document.getElementById('micBtn');
    const SR      = window.SpeechRecognition || window.webkitSpeechRecognition;

    // --- ××•×›× ×•×ª ×”×•×•×™×“×’'×˜ ---
    const messengerReady = (async () => {
      if (!customElements.get('df-messenger')) {
        await customElements.whenDefined('df-messenger');
      }
      try { bubble.openChat(); } catch(_) {}
      return true;
    })();

    // --- TTS ×™×¦×™×‘ (×˜×™×¤×•×œ ×‘×˜×¢×™× ×ª ×§×•×œ×•×ª) ---
    let heVoice = null;
    function pickVoice(){
      try{
        const voices = speechSynthesis.getVoices() || [];
        heVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('he')) || null;
      }catch(_){}
    }
    if ('speechSynthesis' in window) {
      pickVoice();
      // ×‘×—×œ×§ ××”×“×¤×“×¤× ×™× ×”×§×•×œ×•×ª × ×˜×¢× ×™× ×‘××™×—×•×¨
      window.speechSynthesis.addEventListener('voiceschanged', pickVoice);
    }
    function speak(text){
      if (!('speechSynthesis' in window)) return;
      try { speechSynthesis.cancel(); } catch(_){}
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'he-IL';
      if (heVoice) u.voice = heVoice;
      speechSynthesis.speak(u);
    }

    // --- ×”×¦×’×ª ×ª×©×•×‘×ª ×”×‘×•×˜ ×‘×§×•×œ ---
    df.addEventListener('df-response-received', (e) => {
      try {
        const msgs = e.detail?.response?.queryResult?.responseMessages || [];
        const txt  = msgs.flatMap(m => m.text?.text || []).join(' ').trim();
        if (txt) speak(txt);
      } catch(_) {}
    });

    // --- × ×™×”×•×œ "×‘×§×©×” ×ª×œ×•×™×”" ×›×“×™ ×œ× ×œ×”×™×ª×§×¢ ×¢×œ ×©×œ×™×—×” ---
    let inFlight = false;
    df.addEventListener('df-request-sent',      () => { inFlight = true;  });
    df.addEventListener('df-response-received', () => { inFlight = false; });
    df.addEventListener('df-error',             () => { inFlight = false; });

    // --- ×©×œ×™×—×”: ×’× UI (renderCustomText) ×•×’× ×œ×‘×•×˜ (sendQuery) ---
    async function sendToBotAndRender(text){
      await messengerReady;

      // ×× ×™×© ×‘×§×©×” ×¨×¦×” â€“ × ×—×›×” ××¢×˜ (×¢×“ 6×©')
      const t0 = Date.now();
      while (inFlight && Date.now() - t0 < 6000) {
        await new Promise(r => setTimeout(r, 120));
      }

      // 1) ×œ×•×’ ×”×™×¡×˜×•×¨×™: ×œ×”×¦×™×’ ××ª ×”×”×•×“×¢×” ×©×œ×š ×‘×¦'××˜
      try { df.renderCustomText(text); } catch(_) {}

      // 2) ×©×œ×™×—×” ×‘×¤×•×¢×œ ×œ×‘×•×˜
      return df.sendQuery(text);
    }

    // --- STT ---
    if (!SR) {
      mic.disabled = true;
      mic.textContent = 'ğŸ¤ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”';
      mic.title = 'Web Speech API ×œ× ×–××™×Ÿ. ××•××œ×¥ Chrome/Edge.';
      return;
    }

    let isListening = false;
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    mic.addEventListener('click', async () => {
      if (isListening) return;
      const old = mic.textContent;
      mic.setAttribute('aria-busy','true');
      mic.textContent = 'â³ ××›×™×Ÿ ××™×§×¨×•×¤×•×Ÿ...';

      // ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ (××—×× ×•××•×•×“× ×”×ª×§×Ÿ)
      try { await navigator.mediaDevices.getUserMedia({ audio:true }); }
      catch(e){
        mic.textContent = 'âŒ ××™×Ÿ ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ';
        mic.removeAttribute('aria-busy');
        return;
      }

      await messengerReady;

      isListening = true;
      mic.textContent = 'ğŸ™ï¸ ××§×©×™×‘...';

      const attempt = (retry=false) => new Promise((resolve) => {
        const r = new SR();
        r.lang = 'he-IL';
        r.interimResults = true;
        r.continuous = false;
        let finalText = '';

        r.onresult = (ev) => {
          let interim = '';
          for (let i = ev.resultIndex; i < ev.results.length; i++) {
            const t = ev.results[i][0].transcript || '';
            if (ev.results[i].isFinal) finalText += t;
            else interim += t;
          }
          if (interim) mic.textContent = 'ğŸ™ï¸ ' + interim;
        };

        r.onerror = async (ev) => {
          if (ev.error === 'no-speech' && !retry) {
            r.abort();
            mic.textContent = 'ğŸ—£ï¸ × ×¡×• ×©×•×‘...';
            await sleep(300);
            resolve({ retry:true });
          } else {
            resolve({ finalText:'' });
          }
        };

        r.onend = () => resolve({ finalText });
        try { r.start(); } catch(e) { resolve({ finalText:'' }); }
      });

      let res = await attempt(false);
      if (res.retry) {
        mic.textContent = 'ğŸ™ï¸ ××§×©×™×‘...';
        res = await attempt(true);
      }

      mic.removeAttribute('aria-busy');
      mic.textContent = old;
      isListening = false;

      const text = (res.finalText || '').trim();
      if (!text) {
        mic.title = '×œ× ×–×•×”×” ×“×™×‘×•×¨. ×“×‘×¨/×™ ×‘×¨×•×¨ ×™×•×ª×¨ ××• ×‘×“×•×§/×™ ××ª ×‘×—×™×¨×ª ×”××™×§×¨×•×¤×•×Ÿ.';
        return;
      }

      // ×©×œ×™×—×” + ×›×ª×™×‘×” ×œ×”×™×¡×˜×•×¨×™×” + TTS ×ª×©×•×‘×”
      try {
        mic.textContent = 'ğŸ“¤ ×©×•×œ×—...';
        await sendToBotAndRender(text);
      } catch(e) {
        console.error('[DF] send failed', e);
      } finally {
        mic.textContent = old;
      }
    });
  })();
  </script>
</body>
</html>
