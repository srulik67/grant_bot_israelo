<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</title>

  <!-- Dialogflow Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    body{margin:0;font-family:system-ui,"Segoe UI",Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px}
    p{margin:0 0 12px;color:#444}
    .actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    df-messenger{
      position:fixed;bottom:16px;right:16px;z-index:999;direction:rtl;
      --df-messenger-font-family:system-ui,"Segoe UI",Arial,sans-serif;
    }
    button{padding:10px 14px;border:0;border-radius:999px;cursor:pointer;font-size:16px}
    #micBtn{background:#0b57d0;color:#fff;min-width:140px}
    #micBtn[aria-busy="true"]{background:#d00}
    #testBtn{background:#eee}
    #status{font-size:13px;color:#666}
    pre.log{background:#111;color:#0f0;padding:8px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</h1>
    <p>×œ×—×¦×• ×¢×œ ğŸ¤, ×“×‘×¨×• â€” ×”×‘×•×˜ ×™×›×ª×•×‘ ×‘×¦×³××˜ ×•×™×§×¨× ××ª ×”×ª×©×•×‘×” ×‘×§×•×œ.</p>
    <div class="actions">
      <button id="micBtn"  type="button" title="×“×‘×¨/×™">ğŸ¤ ×“×‘×¨/×™</button>
      <button id="testBtn" type="button" title="×‘×“×™×§×ª TTS">ğŸ”Š ×‘×“×™×§×ª ×§×•×œ</button>
      <span id="status"></span>
    </div>
    <pre id="debugLog" class="log"></pre>
  </div>

  <df-messenger
    project-id="sandbox-kosta-test"
    agent-id="bc0af719-bdac-48d8-ba78-3befdd3c5a00"
    location="europe-west1"
    language-code="he-il"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="×‘×•×˜ ××¢× ×§ ×¢×‘×•×“×”"></df-messenger-chat-bubble>
  </df-messenger>

  <audio id="ttsAudio"></audio>

  <script>
  (()=>{
    // === ×©×™× ×›××Ÿ ××¤×ª×— API ×©×œ Google Cloud Text-to-Speech ===
    const GCP_TTS_API_KEY = 'AIzaSyCK_SVmworiDMH9iE5L1lvjh4cdA6KB92I';

    const df   = document.querySelector('df-messenger');
    const mic  = document.getElementById('micBtn');
    const test = document.getElementById('testBtn');
    const outA = document.getElementById('ttsAudio');
    const statusEl = document.getElementById('status');
    const logEl    = document.getElementById('debugLog');
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

    function setStatus(t){ statusEl.textContent = t||''; }
    function log(...a){ console.log('[TTS]', ...a); try{ logEl.style.display='block'; logEl.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ')+'\n'; }catch{} }

    // Messenger ready
    const messengerReady = (async ()=>{
      if (!customElements.get('df-messenger')) {
        await customElements.whenDefined('df-messenger');
      }
      return true;
    })();

    // ===== Local Hebrew TTS if available =====
    function getLocalHebrewVoice(){
      try{
        const vs = speechSynthesis.getVoices() || [];
        return vs.find(v => (v.lang||'').toLowerCase().startsWith('he')) || null;
      }catch{ return null; }
    }
    function speakLocal(text){
      if (!('speechSynthesis' in window)) return false;
      const v = getLocalHebrewVoice();
      if (!v) return false;
      try { speechSynthesis.cancel(); } catch(_){}
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'he-IL'; u.voice = v;
      speechSynthesis.speak(u);
      log('Local voice:', v.name, v.lang);
      return true;
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.addEventListener('voiceschanged', ()=>getLocalHebrewVoice());
    }

    // ===== Cloud TTS (×¢× ×œ×•×’ ×©×’×™××” ××¤×•×¨×˜) =====
    async function speakCloud(text){
      if (!GCP_TTS_API_KEY) { setStatus('××™×Ÿ API key'); return false; }
      const url = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=' + encodeURIComponent(GCP_TTS_API_KEY);
      const body = {
        input: { text },
        voice: { languageCode: 'he-IL' }, // ×‘×œ×™ ×©× ×§×•×œ ×›×“×™ ×œ×”×™×× ×¢ ××©×’×™××•×ª Voice Not Found
        audioConfig: { audioEncoding: 'MP3' }
      };
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        log('HTTP status:', res.status);
        const textResp = await res.text();
        let json;
        try { json = JSON.parse(textResp); } catch { json = { raw:textResp }; }
        log('Response:', json);

        if (!res.ok){
          const msg = (json && json.error && (json.error.message || json.error.status)) || 'Bad Request';
          setStatus('TTS × ×›×©×œ ('+res.status+'): ' + msg);
          return false;
        }

        const b64 = json.audioContent;
        if (!b64){ setStatus('××™×Ÿ audioContent'); return false; }
        outA.src = 'data:audio/mp3;base64,' + b64;
        await outA.play();
        setStatus('');
        return true;
      }catch(e){
        log('Fetch error:', e);
        setStatus('×©×’×™××ª ×¨×©×ª ×‘-TTS (×¨××” ×§×•× ×¡×•×œ/×œ×•×’ ×œ××¢×œ×”)');
        return false;
      }
    }

    async function speak(text){
      // ×× ×™×© ×§×•×œ ×¢×‘×¨×™ ××§×•××™ â€“ × ×©×ª××© ×‘×•; ××—×¨×ª ×¢× ×Ÿ
      if (speakLocal(text)) return;
      await speakCloud(text);
    }

    // ===== extract text from bot response =====
    function extractText(resp){
      try{
        const msgs = resp?.queryResult?.responseMessages || [];
        const arr = [];
        for (const m of msgs) if (m.text?.text?.length) arr.push(...m.text.text);
        return arr.join(' ').trim();
      }catch{ return ''; }
    }
    df.addEventListener('df-response-received', (e)=>{
      const txt = extractText(e.detail?.response);
      if (txt) speak(txt);
    });

    // ===== send + render =====
    async function sendToBotAndRender(text){
      await messengerReady;
      try { df.renderCustomText(text); } catch(_) {}
      return df.sendQuery(text);
    }

    // ===== STT =====
    if (!SR) {
      mic.disabled = true;
      mic.textContent = 'ğŸ¤ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”';
      mic.title = 'Web Speech API ×œ× ×–××™×Ÿ. ××•××œ×¥ Chrome/Edge.';
    } else {
      mic.addEventListener('click', async ()=>{
        mic.setAttribute('aria-busy','true');
        const old = mic.textContent;
        mic.textContent = 'ğŸ™ï¸ ××§×©×™×‘...';

        try { await navigator.mediaDevices.getUserMedia({ audio:true }); }
        catch(e){ mic.textContent='âŒ ××™×Ÿ ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ'; mic.removeAttribute('aria-busy'); return; }

        await messengerReady;

        const r = new SR();
        r.lang = 'he-IL';
        r.interimResults = false;
        r.continuous     = false;
        let finalText = '';

        r.onresult = (ev)=>{ finalText = ev.results[0][0].transcript || ''; };
        r.onerror  = (ev)=>{ console.warn('[STT] error', ev); finalText=''; };
        r.onend    = async ()=>{
          mic.textContent = old;
          mic.removeAttribute('aria-busy');
          finalText = (finalText||'').trim();
          if (finalText) { try { await sendToBotAndRender(finalText); } catch(e){ console.warn(e); } }
        };

        try { r.start(); } catch(e) { mic.textContent = old; mic.removeAttribute('aria-busy'); }
      });
    }

    // ===== manual TTS test =====
    test.addEventListener('click', async ()=>{
      setStatus('×‘×•×“×§ TTS...');
      logEl.textContent = ''; logEl.style.display='block';
      const okLocal = speakLocal('×‘×“×™×§×ª ×§×•×œ ×‘×¢×‘×¨×™×ª'); // ×× ×™×© â€“ ×™×ª× ×’×Ÿ ××™×“
      if (!okLocal) await speakCloud('×‘×“×™×§×ª ×§×•×œ ×‘×¢×‘×¨×™×ª');
    });

    // ×˜×™×¤: ×× ××ª×” ××¨×™×¥ ×‘×ª×¦×•×’×ª VSCode (Webview) â€“ ×™×™×ª×›×Ÿ ×©×—×•×¡× ×¨×©×ª.
    // ×ª×‘×“×•×§ ×‘×“×¤×“×¤×Ÿ ×¨×’×™×œ (GitHub Pages / Live Server ××§×•××™).
  })();
  </script>
</body>
</html>
