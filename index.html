<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</title>

  <!-- Dialogflow Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    body{margin:0;font-family:system-ui,"Segoe UI",Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px}
    p{margin:0 0 12px;color:#444}
    df-messenger{
      position:fixed;bottom:16px;right:16px;z-index:999;direction:rtl;
      --df-messenger-font-family:system-ui,"Segoe UI",Arial,sans-serif;
    }
    #micBtn{
      position:fixed;bottom:90px;right:16px;z-index:1000;
      padding:10px 14px;border:0;border-radius:999px;
      background:#0b57d0;color:#fff;cursor:pointer;font-size:16px;min-width:160px
    }
    #micBtn[aria-busy="true"]{background:#d00}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>×”×‘×•×˜ ×”×§×•×œ×™ - ××¢× ×§ ×¢×‘×•×“×”</h1>
    <p>×œ×—×¥/×™ ×¢×œ ğŸ¤, ×“×‘×¨/×™ â€” ×•×”×‘×•×˜ ×™×©×œ×— ××ª ×”×©××œ×” ×•×™×§×¨× ××ª ×”×ª×©×•×‘×” ×‘×§×•×œ.</p>
  </div>

  <button id="micBtn" type="button" title="×“×‘×¨/×™">ğŸ¤ ×“×‘×¨/×™</button>

  <df-messenger
    project-id="sandbox-kosta-test"
    agent-id="bc0af719-bdac-48d8-ba78-3befdd3c5a00"
    location="europe-west1"
    language-code="he-il"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="×‘×•×˜ ××¢× ×§ ×¢×‘×•×“×”"></df-messenger-chat-bubble>
  </df-messenger>

  <audio id="ttsAudio"></audio>

  <script>
  (()=>{
    // ==== ×”×—×œ×£ ×‘××¤×ª×— API ×©×œ Google Cloud Text-to-Speech (×¤×©×•×˜ ×œ×“××•) ====
    const GCP_TTS_API_KEY = 'AIzaSyCK_SVmworiDMH9iE5L1lvjh4cdA6KB92I';

    const df   = document.querySelector('df-messenger');
    const mic  = document.getElementById('micBtn');
    const SR   = window.SpeechRecognition || window.webkitSpeechRecognition;
    const outA = document.getElementById('ttsAudio');

    // ×”×‘×˜×—×ª ×˜×¢×™× ×ª ×”×× ×’× ×•×Ÿ
    const messengerReady = (async ()=>{
      if (!customElements.get('df-messenger')) {
        await customElements.whenDefined('df-messenger');
      }
      return true;
    })();

    // ====== ×©×œ×™×—×”: ×›×•×ª×‘ ××ª ×”××œ×œ ×‘×¦'××˜ (×›××©×ª××©) ×•×©×•×œ×— ×œ×‘×•×˜ ======
    async function sendToBotAndRender(text){
      await messengerReady;
      try { df.renderCustomText(text); } catch(_) {}
      return df.sendQuery(text);
    }

    // ====== ×—×™×œ×•×¥ ×˜×§×¡×˜×™× ××ª×©×•×‘×ª ×”-Agent ======
    function extractText(resp){
      try{
        const msgs = resp?.queryResult?.responseMessages || [];
        const arr = [];
        for (const m of msgs) if (m.text?.text?.length) arr.push(...m.text.text);
        return arr.join(' ').trim();
      }catch{ return ''; }
    }

    // ====== TTS ×”×›×™ ×¤×©×•×˜: ×× ××™×Ÿ ×§×•×œ ×¢×‘×¨×™ ××§×•××™ â€” ×¢× ×Ÿ ======
    function localHebrewVoice(){
      try{
        const vs = speechSynthesis.getVoices() || [];
        return vs.find(v => (v.lang||'').toLowerCase().startsWith('he')) || null;
      }catch{ return null; }
    }

    function speakLocal(text){
      if (!('speechSynthesis' in window)) return false;
      const v = localHebrewVoice();
      if (!v) return false;
      try { speechSynthesis.cancel(); } catch(_){}
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'he-IL'; u.voice = v;
      speechSynthesis.speak(u);
      return true;
    }

    async function speakCloud(text){
      if (!GCP_TTS_API_KEY) return false;
      try{
        const res = await fetch(
          'https://texttospeech.googleapis.com/v1/text:synthesize?key=' + encodeURIComponent(GCP_TTS_API_KEY),
          {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              input: { text },
              voice: { languageCode:'he-IL', name:'he-IL-Standard-A' }, // ×¤×©×•×˜ ×•×§×™×™×
              audioConfig: { audioEncoding:'MP3' }
            })
          }
        );
        if (!res.ok) throw new Error('TTS HTTP ' + res.status);
        const data = await res.json();
        if (!data.audioContent) throw new Error('no audioContent');
        outA.src = 'data:audio/mp3;base64,' + data.audioContent;
        await outA.play().catch(()=>{});
        return true;
      }catch(e){
        console.warn('Cloud TTS failed:', e);
        return false;
      }
    }

    async function speak(text){
      // × ×¡×” ××§×•××™; ×× ××™×Ÿ ×¢×‘×¨×™×ª â€” ×¢× ×Ÿ
      if (speakLocal(text)) return;
      await speakCloud(text);
    }

    // ====== ×›×©××’×™×¢×” ×ª×©×•×‘×” ××”×‘×•×˜ â€” ××§×¨×™××™× ======
    df.addEventListener('df-response-received', (e)=>{
      const txt = extractText(e.detail?.response);
      if (txt) speak(txt);
    });

    // ====== STT ×‘×¡×™×¡×™ ======
    if (!SR) {
      mic.disabled = true;
      mic.textContent = 'ğŸ¤ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”';
      mic.title = 'Web Speech API ×œ× ×–××™×Ÿ. ××•××œ×¥ Chrome/Edge.';
      return;
    }

    mic.addEventListener('click', async ()=>{
      mic.setAttribute('aria-busy','true');
      const old = mic.textContent;
      mic.textContent = 'ğŸ™ï¸ ××§×©×™×‘...';

      // ×‘×§×©×ª ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ (×•×’× "××—×•×•×” ××©×ª××©" ×©×ª××¤×©×¨ × ×™×’×•×Ÿ ××•×“×™×•)
      try { await navigator.mediaDevices.getUserMedia({ audio:true }); } catch(e){
        mic.textContent = 'âŒ ××™×Ÿ ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ';
        mic.removeAttribute('aria-busy'); return;
      }

      await messengerReady;

      const r = new SR();
      r.lang = 'he-IL';
      r.interimResults = false;   // ×¤×©×•×˜: ×¨×§ ×ª×•×¦××” ×¡×•×¤×™×ª
      r.continuous     = false;

      let finalText = '';
      r.onresult = (ev)=>{ finalText = ev.results[0][0].transcript || ''; };
      r.onerror  = ()=>{ finalText = ''; };
      r.onend    = async ()=>{
        mic.textContent = old;
        mic.removeAttribute('aria-busy');
        finalText = (finalText||'').trim();
        if (finalText) {
          try { await sendToBotAndRender(finalText); } catch(e){ console.warn(e); }
        } else {
          mic.title = '×œ× ×–×•×”×” ×“×™×‘×•×¨. × ×¡×”/×™ ×©×•×‘.';
        }
      };

      try { r.start(); } catch(e) {
        mic.textContent = old;
        mic.removeAttribute('aria-busy');
      }
    });
  })();
  </script>
</body>
</html>
